<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | LibraryHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Admin Dashboard</h1>
            <div>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <button type="submit" class="hover:text-gray-200">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Flash Messages -->
        <div th:if="${success}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            <span th:text="${success}"></span>
        </div>
        
        <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <span th:text="${error}"></span>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-2">Total Users</h3>
                <p class="text-3xl font-bold text-indigo-600" th:text="${totalUsers}">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-2">Total Books</h3>
                <p class="text-3xl font-bold text-indigo-600" th:text="${totalBooks}">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-2">Active Borrowings</h3>
                <p class="text-3xl font-bold text-green-600">
                    <span th:if="${dashboardStats != null and dashboardStats.containsKey('activeBorrowings')}" 
                          th:text="${dashboardStats.get('activeBorrowings')}">0</span>
                    <span th:if="${dashboardStats == null or not dashboardStats.containsKey('activeBorrowings')}">0</span>
                </p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-2">Overdue Books</h3>
                <p class="text-3xl font-bold text-red-600">
                    <span th:if="${dashboardStats != null and dashboardStats.containsKey('overdueBooks')}" 
                          th:text="${dashboardStats.get('overdueBooks')}">0</span>
                    <span th:if="${dashboardStats == null or not dashboardStats.containsKey('overdueBooks')}">0</span>
                </p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">User Role Distribution</h3>
                <div class="h-64">
                    <canvas id="userRoleChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">Book Status Distribution</h3>
                <div class="h-64">
                    <canvas id="bookStatusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- User Distribution Card (Original - Keeping it) -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-semibold mb-2">User Distribution by Role</h3>
            <div class="space-y-2">
                <div th:each="stat : ${userStats}">
                    <span class="font-medium" th:text="${stat.key}">Role</span>: 
                    <span th:text="${stat.value}">0</span>
                </div>
                <div th:if="${userStats == null or userStats.empty}" class="text-gray-500">
                    No user role data available
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="px-6 py-4 border-b">
                <h2 class="text-xl font-semibold">Registered Users</h2>
                <span class="text-sm text-gray-500">Total: <span th:text="${totalUsers}">0</span> users</span>
            </div>
            
            <div class="p-6 overflow-x-auto">
                <!-- Check if users list is empty -->
                <div th:if="${users == null or users.empty}" class="text-center py-8">
                    <p class="text-gray-500">No users found or users list is null</p>
                </div>
                
                <table class="w-full" th:if="${users != null and not users.empty}">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr th:each="user, stat : ${users}">
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${user.id}">ID</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <img th:if="${user.profileImagePath}" th:src="${user.profileImagePath}" alt="Profile" class="h-8 w-8 rounded-full mr-3">
                                    <span th:text="${user.name}">User Name</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${user.email}">user@email.com</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span th:text="${user.role}">GUEST</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap space-x-2">
                                <!-- View Details Button -->								
								<button th:onclick="'showUserDetails(' + ${user.id} + ')'" 
								        class="text-blue-600 hover:text-blue-900 text-sm">
								    View Details
								</button>
								
								
                                
                                <!-- Reset Password Button -->
                                <form th:action="@{/admin/users/{id}/trigger-reset(id=${user.id})}" 
                                      method="post" style="display: inline;">
                                    <button type="submit" 
                                            onclick="return confirm('Send password reset email to this user?')"
                                            class="text-green-600 hover:text-green-900 text-sm">
                                        Reset Password
                                    </button>
                                </form>
                                
                                <!-- Delete Button -->
                                <form th:action="@{/admin/users/{id}/delete(id=${user.id})}" 
                                      method="post" style="display: inline;">
                                    <button type="submit" 
                                            onclick="return confirm('Are you sure you want to delete this user?')"
                                            class="text-red-600 hover:text-red-900 text-sm">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Books Table -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="px-6 py-4 border-b">
                <h2 class="text-xl font-semibold">Books Management</h2>
            </div>
            <div class="p-6 overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cover</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr th:each="book : ${books}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <img th:if="${book.coverImagePath}" th:src="${book.coverImagePath}" alt="Book Cover" class="h-12 w-12 object-cover rounded">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${book.title}">Book Title</td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${book.author}">Author Name</td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${book.status}">AVAILABLE</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <form th:action="@{/admin/books/{id}/delete(id=${book.id})}" method="post" style="display: inline;">
                                    <button type="submit" class="text-red-600 hover:text-red-900"
                                            onclick="return confirm('Are you sure you want to delete this book?')">Delete</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">User Details</h3>
                <button onclick="closeUserDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="userDetailsContent">
                <!-- Content will be loaded via AJAX -->
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Loading user details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden data for JavaScript (Safe from Thymeleaf errors) -->
    <div id="chartData" style="display: none;">
        <!-- User Role Data -->
        <div id="userRoleLabels">
            <span th:if="${dashboardStats != null and dashboardStats.containsKey('userRoleDistribution')}">
                <span th:each="entry : ${dashboardStats.get('userRoleDistribution')}">
                    <span class="label" th:text="${entry.key}"></span>
                </span>
            </span>
        </div>
        <div id="userRoleValues">
            <span th:if="${dashboardStats != null and dashboardStats.containsKey('userRoleDistribution')}">
                <span th:each="entry : ${dashboardStats.get('userRoleDistribution')}">
                    <span class="value" th:text="${entry.value}"></span>
                </span>
            </span>
        </div>
        
        <!-- Book Status Data -->
        <div id="bookStatusLabels">
            <span th:if="${dashboardStats != null and dashboardStats.containsKey('bookStatusDistribution')}">
                <span th:each="entry : ${dashboardStats.get('bookStatusDistribution')}">
                    <span class="label" th:text="${entry.key}"></span>
                </span>
            </span>
        </div>
        <div id="bookStatusValues">
            <span th:if="${dashboardStats != null and dashboardStats.containsKey('bookStatusDistribution')}">
                <span th:each="entry : ${dashboardStats.get('bookStatusDistribution')}">
                    <span class="value" th:text="${entry.value}"></span>
                </span>
            </span>
        </div>
    </div>

    <script>
		


		
        // User Details Modal Functions
		function showUserDetails(userId) {
		    console.log('showUserDetails called with userId:', userId);
		    document.getElementById('userDetailsModal').classList.remove('hidden');
		    
		    const url = '/admin/users/' + userId + '/details';
		    console.log('Fetching from URL:', url);
		    
		    // Load user details via AJAX
		    fetch(url)
		        .then(response => {
		            console.log('Response status:', response.status);
		            console.log('Response ok:', response.ok);
		            if (!response.ok) {
		                throw new Error('Network response was not ok: ' + response.status);
		            }
		            return response.text();
		        })
		        .then(html => {
		            console.log('Received HTML length:', html.length);
		            console.log('HTML content:', html.substring(0, 200));
		            document.getElementById('userDetailsContent').innerHTML = html;
		        })
		        .catch(error => {
		            console.error('Error loading user details:', error);
		            document.getElementById('userDetailsContent').innerHTML = 
		                '<div class="text-red-600 p-4 text-center">Error loading user details: ' + error.message + '</div>';
		        });
		}
        
        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
            // Reset content for next open
            document.getElementById('userDetailsContent').innerHTML = 
                '<div class="text-center py-8">' +
                '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>' +
                '<p class="mt-2 text-gray-600">Loading user details...</p>' +
                '</div>';
        }
        
        // Close modal on outside click
        document.getElementById('userDetailsModal').addEventListener('click', function(e) {
            if (e.target.id === 'userDetailsModal') {
                closeUserDetailsModal();
            }
        });
        
        // Helper function to extract data from hidden divs
        function getChartData(labelDivId, valueDivId) {
            const labelDiv = document.getElementById(labelDivId);
            const valueDiv = document.getElementById(valueDivId);
            
            if (!labelDiv || !valueDiv) {
                return { labels: ['No Data'], values: [1] };
            }
            
            const labelElements = labelDiv.querySelectorAll('.label');
            const valueElements = valueDiv.querySelectorAll('.value');
            
            if (labelElements.length === 0 || valueElements.length === 0) {
                return { labels: ['No Data'], values: [1] };
            }
            
            const labels = Array.from(labelElements).map(el => el.textContent);
            const values = Array.from(valueElements).map(el => parseInt(el.textContent) || 0);
            
            return { labels, values };
        }
        
        // Initialize Charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // User Role Distribution Chart
            const userRoleCtx = document.getElementById('userRoleChart');
            if (userRoleCtx) {
                const userRoleData = getChartData('userRoleLabels', 'userRoleValues');
                
                const userRoleChart = new Chart(userRoleCtx, {
                    type: 'pie',
                    data: {
                        labels: userRoleData.labels,
                        datasets: [{
                            data: userRoleData.values,
                            backgroundColor: [
                                '#4F46E5', // indigo
                                '#10B981', // emerald
                                '#F59E0B', // amber
                                '#EF4444', // red
                                '#8B5CF6', // violet
                                '#06B6D4'  // cyan
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }
            
            // Book Status Distribution Chart
            const bookStatusCtx = document.getElementById('bookStatusChart');
            if (bookStatusCtx) {
                const bookStatusData = getChartData('bookStatusLabels', 'bookStatusValues');
                
                const bookStatusChart = new Chart(bookStatusCtx, {
                    type: 'bar',
                    data: {
                        labels: bookStatusData.labels,
                        datasets: [{
                            label: 'Number of Books',
                            data: bookStatusData.values,
                            backgroundColor: '#4F46E5',
                            borderColor: '#3730A3',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    precision: 0
                                },
                                grid: {
                                    display: true
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Auto-hide success/error messages after 5 seconds
            setTimeout(() => {
                const messages = document.querySelectorAll('.bg-green-100, .bg-red-100');
                messages.forEach(msg => {
                    msg.style.opacity = '0';
                    msg.style.transition = 'opacity 0.5s';
                    setTimeout(() => msg.style.display = 'none', 500);
                });
            }, 5000);
        });
        
        // Handle Enter key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeUserDetailsModal();
            }
        });
    </script>
</body>
</html>